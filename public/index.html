<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Nairobi LULC Dashboard</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    #map { height: 60vh; }
    #dashboard { padding: 10px; }
  </style>
</head>
<body>
  <h2>Nairobi LULC Change Detection</h2>
  <div id="map"></div>
  <div id="dashboard">
    <h3>Land Use Statistics</h3>
    <canvas id="lulcChart" width="400" height="200"></canvas>
  </div>

  <script>
    // Initialize map
    const map = L.map("map").setView([-1.2921, 36.8219], 10); // Nairobi center

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
    }).addTo(map);

    // Add LULC raster layers
    const lulc2019 = L.tileLayer("http://localhost:5000/api/lulc/2019/tile/{z}/{x}/{y}.png", {
      attribution: "LULC 2019",
    }).addTo(map);

    const lulc2025 = L.tileLayer("http://localhost:5000/api/lulc/2025/tile/{z}/{x}/{y}.png", {
      attribution: "LULC 2025",
    });

    const overlayMaps = {
      "LULC 2019": lulc2019,
      "LULC 2025": lulc2025,
    };

    L.control.layers(null, overlayMaps).addTo(map);

    // Fetch statistics and render chart
    fetch("http://localhost:5000/api/lulc/stats")
      .then(res => {
        if (!res.ok) throw new Error("Network response was not ok");
        return res.json();
      })
      .then(data => {
        const labels = data.map(row => row.class_name);
        const area2019 = data.map(row => row.area_2019);
        const area2025 = data.map(row => row.area_2025);

        new Chart(document.getElementById("lulcChart"), {
          type: "bar",
          data: {
            labels: labels,
            datasets: [
              { label: "2019", data: area2019, backgroundColor: "blue" },
              { label: "2025", data: area2025, backgroundColor: "red" },
            ],
          },
          options: { responsive: true, plugins: { legend: { position: "bottom" } } },
        });
      })
      .catch(error => {
        document.getElementById("dashboard").innerHTML += "<p style='color:red;'>Failed to load statistics.</p>";
        console.error("Fetch error:", error);
      });
  </script>
</body>
</html>
